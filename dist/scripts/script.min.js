var app=app||{};!function(e){"use strict";app.load=function(){var e=new app.NeighborhoodViewModel;ko.applyBindings(e),e.load()};var o=function(){var e=this;e.markers=[],e.markersInfo=ko.observableArray(),e.listVisibleArray=ko.observableArray(),e.foursquareIDs=[]},t=function(){var e=this;e.availablePrice=["$","$$","$$$","$$$$"],e.price=ko.observableArray(),e.rating=ko.observable(1)};app.NeighborhoodViewModel=function(){var a=this;a.map=null,a.locations=new o,a.filters=new t,a.searchText=e("#searchField"),a.searchBox,a.listVisible=ko.observable(!0),a.detailVisible=ko.observable(!1),a.hoverMarker=null,a.selectedMarker=null,a.selectedMarkerInfo=ko.observable(),a.placeService=null,a.wikiText=ko.observable(),a.load=function(){e("#map").text="",i(),n()};var n=function(){"object"==typeof google&&"object"==typeof google.maps?(a.selectedMarker=new google.maps.Marker({position:{lat:0,lng:0}}),a.hoverMarker=new google.maps.Marker({position:{lat:0,lng:0}})):console.log("google maps wasn't loaded properly")};a.showMarker=function(e,o){e.title=o.name,e.position=new google.maps.LatLng(o.geometry.H,o.geometry.L,!1),e.setMap(a.map)},a.removeMarker=function(e){e.setMap(null)},a.showDetail=function(e,o){a.listVisible(!1),a.detailVisible(!0),a.locations.markers.forEach(function(e){Math.abs(e.position.H-o.geometry.H)<1e-5&&Math.abs(e.position.L-o.geometry.L)<1e-5&&(console.log("match found"),a.removeMarker(e))}),a.showMarker(e,o),a.selectedMarkerInfo(o),a.selectedMarker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){a.selectedMarker.setAnimation(null)},700)},a.hideDetail=function(){var e=a.selectedMarkerInfo();a.detailVisible(!1),a.listVisible(!0),e&&a.locations.markers.forEach(function(o){o.position.H-e.geometry.H<1e-5&&o.position.L-e.geometry.L<1e-5&&o.setMap(a.map)}),a.removeMarker(a.selectedMarker),a.selectedMarkerInfo(null)};var r=function(){a.locations.markersInfo.removeAll(),a.locations.markers.forEach(function(e){e.setMap(null)}),a.locations.markers=[],a.listVisible(!0),a.detailVisible(!1),a.selectedMarkerInfo(null),a.wikiText(""),a.locations.foursquareIDs=[]};a.resetSearch=function(){console.log("reset search()"),a.searchText[0].value="",r()},a.toggleFilter=function(){e(".filter-group").toggleClass("slide")},a.filterResults=function(){for(var e=null,o=0,t=a.locations.markersInfo().length;t>o;o++){e=a.locations.markersInfo()[o];var n=!1,r=!1;if(0===a.filters.price().length)console.log("no price filter"),n=!0;else if(e.price)for(var s=0;s<a.filters.price().length;s++)if(e.price===a.filters.price()[s]){console.log("price matched!"+e.price+" "+a.filters.price()[s]),n=!0;break}a.filters.rating()<=1?r=!0:e.rating&&e.rating>=a.filters.rating()&&(console.log("rating matched!"+e.rating+" "+a.filters.rating()),r=!0),n===!0&&r===!0?(e.visible=!0,a.locations.markersInfo.splice(o,1),a.locations.markersInfo.splice(o,0,e),a.locations.markers[o].setMap(a.map)):(e.visible=!1,a.locations.markersInfo.splice(o,1),a.locations.markersInfo.splice(o,0,e),a.locations.markers[o].setMap(null))}};var s=function(o){var t=/,\sUSA/,n=/\s/g,r=/,/,s=o.replace(t,"").replace(n,"%20").replace(r,"%2C"),l=setTimeout(function(){a.wikiText("Failed to get wikipedia resources")},8e3),i="https://en.wikipedia.org/w/api.php?action=query&prop=extracts&format=json&exsentences=4&exintro=&explaintext=&exsectionformat=plain&titles="+s+"&generator=redirects&redirects=&grdprop=title&callback=wikiCallback";e.ajax({url:i,dataType:"jsonp",jsonp:"callback",success:function(e){for(var o in e.query.pages)a.wikiText(e.query.pages[o].extract),clearTimeout(l)}})},l=function(o,t){var n="5OEUZBD0W0WYJWSM5MF55Y2ZVCXBYKAMJCNCIYOEXFMDEIPK",r="0FBED51EERO35ZVHFV5BHQSDA52QDRMC55QMVU2U23LBRXL2",s=/,/;o=o.replace(s,"");var l="https://api.foursquare.com/v2/venues/search?query="+o+"&ll="+t.lat()+","+t.lng()+"&limit=20&client_id="+n+"&client_secret="+r+"&v=20150927",i=setTimeout(function(){window.alert("foursquare API can't be reached")},8e3);e.ajax({url:l,dataType:"jsonp",jsonp:"callback",success:function(o){clearTimeout(i);for(var t=o.response.venues.length,s=0;t>s;s++)a.locations.foursquareIDs.push(o.response.venues[s].id);a.locations.foursquareIDs.forEach(function(o){var t="https://api.foursquare.com/v2/venues/"+o+"?&client_id="+n+"&client_secret="+r+"&v=20150927";e.ajax({url:t,dataType:"jsonp",jsonp:"callback",success:function(e){var o=e.response.venue,t=null,n=null,r=null,s=null;if(o.bestPhoto&&(t={pre:o.bestPhoto.prefix,suf:o.bestPhoto.suffix}),o.price){n="";for(var l=o.price.tier,i=0;l>i;i++)n=n.concat("$")}if(o.tips){r=o.tips.groups[0].items;var c=3;r.length>c&&r.splice(c,r.length-c)}o.categories.length>0&&(s=o.categories[0].name),a.locations.markersInfo.push({name:o.name,address:o.location.address+", "+o.location.formattedAddress[1],website:o.url,phone:o.contact,photo:t,rating:o.rating,ratingColor:o.ratingColor,hours:o.hours,price:n,tips:r,types:s,geometry:{H:o.location.lat,L:o.location.lng},id:o.id,visible:!0});var p=a.locations.markersInfo().length;!function(e){a.locations.markers.push(new google.maps.Marker({map:a.map,icon:"https://playfoursquare.s3.amazonaws.com/press/2014/foursquare-icon-16x16.png",title:e.name,position:{lat:e.location.lat,lng:e.location.lng},animation:google.maps.Animation.DROP})),a.locations.markers[a.locations.markers.length-1].addListener("click",function(e){return function(){console.log("marker clicked"),a.showDetail(a.selectedMarker,a.locations.markersInfo()[p-1])}}())}(o)}})}),a.map.setZoom(12)}})},i=function(){if("object"==typeof google&&"object"==typeof google.maps){a.map=new google.maps.Map(document.getElementById("map"),{center:{lat:37.351073,lng:-121.887451},scrollwheel:!0,panControl:!1,mapTypeControl:!1,zoom:11,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.RIGHT_BOTTOM},styles:[{elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"administrative.locality",stylers:[{visibility:"on"}]}]});var e,o="sushi";navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){console.log(t),e=new google.maps.LatLng(t.coords.latitude,t.coords.longitude),a.map.setCenter(e),a.searchText[0].value=o,l(o,a.map.getCenter())},function(){console.log("no geolocation"),a.searchText[0].value=o,l(o,a.map.getCenter())}):(console.log("geolocation not supported.."),a.searchText[0].value=o,l(o,a.map.getCenter()));var t=document.getElementById("filter-toggle"),n=document.getElementById("dollarInput"),r=document.getElementById("ratingInput"),s=document.getElementById("filterBtn");a.map.controls[google.maps.ControlPosition.RIGHT_TOP].push(t),a.map.controls[google.maps.ControlPosition.RIGHT_TOP].push(n),a.map.controls[google.maps.ControlPosition.RIGHT_TOP].push(r),a.map.controls[google.maps.ControlPosition.RIGHT_TOP].push(s);var i=document.getElementById("searchField");a.searchBox=new google.maps.places.SearchBox(i),a.map.controls[google.maps.ControlPosition.LEFT_TOP].push(i);var p=document.getElementById("clear-search");a.map.controls[google.maps.ControlPosition.LEFT_TOP].push(p);var g=document.getElementById("side-list");a.map.controls[google.maps.ControlPosition.LEFT_TOP].push(g);var m=document.getElementById("list-detail");m.index=10,a.map.controls[google.maps.ControlPosition.LEFT_TOP].push(m),a.service=new google.maps.places.PlacesService(a.map),a.map.addListener("click",function(){a.selectedMarkerInfo&&a.hideDetail()}),a.map.addListener("bounds_changed",function(){a.searchBox.setBounds(a.map.getBounds())}),a.searchBox.addListener("places_changed",c)}else console.log("google maps API wasn't loaded properly"),window.alert("google maps wasn't loaded properly")},c=function(){var e="",o=a.searchBox.getPlaces(),t=o.length;if(0===t)return void console.log("no Searchbox result");1===t?(e="GOOGLE","locality"===o[0].types[0]&&(console.log("make wiki request for "+o[0].formatted_address),s(o[0].formatted_address))):o.length>1&&(e="FOURSQUARE",l(a.searchText[0].value,a.map.getCenter())),r();var n,i=new google.maps.LatLngBounds;if("GOOGLE"===e){n=o[0];var c={url:n.icon,size:new google.maps.Size(50,50),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};!function(e){a.locations.markers.push(new google.maps.Marker({map:a.map,icon:c,title:e.name,position:e.geometry.location,animation:google.maps.Animation.DROP})),a.locations.markers[0].addListener("click",function(e){return function(){console.log("marker clicked"),a.showDetail(a.selectedMarker,a.locations.markersInfo()[0])}}())}(n),n.geometry.viewport?i.union(n.geometry.viewport):i.extend(n.geometry.location),a.map.fitBounds(i),a.service.getDetails({placeId:n.place_id},function(e,o){o===google.maps.places.PlacesServiceStatus.OK?a.locations.markersInfo.push({name:e.name,address:e.formatted_address,website:null,phone:null,photo:null,rating:null,price:null,hours:null,tips:null,types:e.types,geometry:e.geometry.location,id:e.place_id,visible:!0}):o===google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT?console.log("reaches query limit"):o===google.maps.places.PlacesServiceStatus.ERROR&&(console.log("error contacting google server for location details"),window.alert("can't retrieve info from google server"))})}};ko.bindingHandlers.fadeVisible={init:function(o,t){var a=t();e(o).toggle(ko.unwrap(a))},update:function(o,t){var a=t();ko.unwrap(a)?e(o).fadeIn():e(o).fadeOut()}}}}(jQuery);